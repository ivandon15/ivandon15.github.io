---
title: 
description: >-
  My first blog, trying to record how I built a personal blog based on Github Pages and Chirpy.
author: 
   - ivan 
   - chatgpt
date: '2025-09-28 22:44:17 +0800'
categories: [Tutorial]
tags: [blogs]
pin: false
media_subpath: '/assets/img/posts/tutorial/2025-09-28-pack-pypi'
---

## Preface

This article is based on the modern Python packaging ecosystem (PEP 621 / PEP 517/518, with `pyproject.toml` at the center), and also provides a minimal `setup.py` example for compatibility with legacy projects or scenarios requiring programmatic builds. For detailed specifications of `pyproject.toml` and the behavior of `build-system`, please refer to the official documentation and PEPs ([packaging.python.org][1]).

---

## Minimal Project Structure (Example)

```
your_project/
├── src/
│   └── your_package/
│       └── __init__.py
├── tests/
├── README.md
├── LICENSE
├── pyproject.toml
├── setup.py         # Optional: keep only if programmatic steps are required
├── MANIFEST.in      # Optional: include additional resources
```

Explanation: It is recommended to use the `src/` layout (which helps avoid debugging issues with same-name packages). Place documentation in `README.md`, and declare metadata in `pyproject.toml`. For a complete guide on writing `pyproject.toml`, see the official Packaging documentation ([packaging.python.org][1]).

---

## pyproject.toml — Full Example with Line-by-Line Explanation

### Example File

```toml
[build-system]
requires = ["setuptools>=61", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "your-package-name"
version = "0.1.0"
description = "A short description of the package."
readme = { file = "README.md", content-type = "text/markdown" }
requires-python = ">=3.8"
authors = [{ name = "Your Name", email = "you@example.com" }]
license = { text = "MIT" }
dependencies = [
  "requests>=2.25",
  "numpy>=1.21"
]
classifiers = [
  "Programming Language :: Python :: 3",
  "License :: OSI Approved :: MIT License",
  "Operating System :: OS Independent"
]

[project.optional-dependencies]
dev = ["pytest", "black", "sphinx"]

[project.scripts]
your-cmd = "your_package.cli:main"
```

Below is a detailed explanation of each section and its common usage.

---

### 【build-system】

```toml
[build-system]
requires = ["setuptools>=61", "wheel"]
build-backend = "setuptools.build_meta"
```

* `requires`: List of packages needed during the build process. Pip installs these dependencies first. Common values are `setuptools` + `wheel` (sometimes `build`, `flit`, etc., depending on the chosen backend). This field is defined by PEP 517/518 to tell tools which dependencies must be present before building ([PEPs][2]).
* `build-backend`: Specifies the backend, such as `setuptools.build_meta`, `flit_core.buildapi`, or `poetry.core.masonry.api`. The backend is responsible for building the sdist/wheel ([PEPs][2]).

In practice, I usually just copy these values directly.

---

### 【project】

This table follows the PEP 621 metadata specification, i.e., declaring package metadata in the `[project]` section of `pyproject.toml` ([PEPs][3]).

* `name`: Distribution name (the name shown on PyPI and used in `pip install name`). Follow naming conventions (lowercase, hyphenated), and check availability before publishing.
* `version`: Version number following PEP 440 (semantic versioning or your own strategy). You can also use `dynamic = ["version"]` to let the backend populate it dynamically (e.g., from git tags) ([packaging.python.org][1]).
* `description`: A short one-line summary.
* `readme`: Can be a simple string path or a table with `file`/`content-type`. Modern tools use the README as the long description. Example: `{ file = "README.md", content-type = "text/markdown" }` ([packaging.python.org][1]).
* `requires-python`: Specifies compatible Python versions (e.g., `>=3.8`). Pip and indexes will refuse incompatible environments.
* `authors` / `maintainers`: Lists of authors/maintainers with `name` and `email`.
* `license`: Use `{ text = "MIT" }` or `{ file = "LICENSE" }` to declare the license. Different backends handle these slightly differently ([packaging.python.org][1]).
* `dependencies`: Main dependencies written in PEP 508 syntax (e.g., `"requests>=2.25"`). These will be written to the built package’s `METADATA` ([packaging.python.org][1]).
* `classifiers`: Classifiers shown on PyPI (helpful for discovery), e.g., Python version / License / OS.
* `urls`: Optional homepage / repository / documentation links for display on PyPI.

---

### entry points / console scripts

```toml
[project.scripts]
your-cmd = "your_package.cli:main"
```

* This means that when the package is installed, an executable command `your-cmd` will be created, pointing to the `main` function inside `your_package.cli`.

Copy-and-paste friendly.

---

### optional-dependencies / dynamic

* `[project.optional-dependencies]`: Defines optional dependency groups (e.g., `dev`, `docs`, `tests`). Users can install via `pip install your-package[dev]`.
* `dynamic`: If some fields are generated dynamically (e.g., `version`), declare `dynamic = ["version"]` in `[project]` and ensure the backend supports it ([packaging.python.org][1]).

---

## setup.py — Example and Explanation

### Why do modern projects prefer `pyproject.toml`?

PEP 517/621 encourage consolidating metadata and build configuration into `pyproject.toml`, reducing reliance on `setup.py`. In most cases, declarative configuration (`pyproject.toml`, `setup.cfg`) is sufficient. Retain `setup.py` only when programmatic steps are required (e.g., building C extensions, generating files during packaging). Official setuptools docs recommend using declarative configs whenever possible ([setuptools.pypa.io][5]).

### Minimal `setup.py` Example

```python
# setup.py (minimal example)
from setuptools import setup, find_packages
from pathlib import Path

README = Path(__file__).parent.joinpath("README.md").read_text(encoding="utf-8")

setup(
    name="your-package-name",
    version="0.1.0",
    description="A short description of the package.",
    long_description=README,
    long_description_content_type="text/markdown",
    author="Your Name",
    author_email="you@example.com",
    packages=find_packages(where="src"),
    package_dir={"": "src"},
    include_package_data=True,
    python_requires=">=3.8",
    install_requires=[
        "requests>=2.25",
    ],
    entry_points={
        "console_scripts": [
            "your-cmd=your_package.cli:main",
        ]
    },
    classifiers=[
        "Programming Language :: Python :: 3",
        "License :: OSI Approved :: MIT License",
        "Operating System :: OS Independent",
    ],
)
```

* `find_packages(where="src")` + `package_dir` work with the `src/` layout.
* `include_package_data=True` includes resources specified in `MANIFEST.in` into the sdist.
* If only declarative metadata is needed, prefer putting fields in `pyproject.toml` / `setup.cfg`, and keep `setup.py` minimal or only for programmatic logic ([setuptools.pypa.io][5]).

---

## Packaging and Uploading (Command Summary)

1. Install build tools:

   ```bash
   pip install --upgrade build
   ```

2. Build the distribution (sdist + wheel):

   ```bash
   python -m build
   ```

   The results are placed in the `dist/` directory.
   The tool reads `[build-system]` in `pyproject.toml`, installs build dependencies, and calls the backend ([PEPs][2]).

3. Install the upload tool (Twine):

   ```bash
   pip install --upgrade twine
   ```

4. **Test upload to TestPyPI first** (verify metadata, README rendering, package name):

   ```bash
   twine upload --repository testpypi dist/*
   ```

   Check that the package displays and installs correctly on TestPyPI before uploading to the official PyPI ([packaging.python.org][6]).

5. Upload to PyPI:

   ```bash
   twine upload dist/*
   ```

6. About PyPI API tokens: Generate tokens on the PyPI website. During upload, set username to `__token__` and password to the token (with `pypi-` prefix). In CI, store them as `TWINE_USERNAME`/`TWINE_PASSWORD` or configure in `~/.pypirc`. Use encrypted secrets in CI (never store tokens in plaintext) ([PyPI][7]).

---

## Common Errors and Troubleshooting

* **Package name already taken / 403 name collision**: Search on TestPyPI/PyPI before publishing. If taken, rename or contact the owner.
* **long_description fails to render on PyPI**: Ensure `readme`/`long_description_content_type` is correct (`text/markdown`). Check locally with `twine check dist/*`.
* **twine authentication failed (403/401)**: Usually token/credential issues. Generate a PyPI API token and use `__token__` as username ([PyPI][7]).
* **Build fails, backend/dep missing**: Ensure `[build-system].requires` includes required packages (`setuptools`, `wheel`), and upgrade locally/CI as needed ([PEPs][2]).
* **Missing non-Python files (templates/data)**: Use `MANIFEST.in` + `include_package_data=True` to include extra resources. See setuptools docs ([setuptools.pypa.io][5]).

---

[1]: https://packaging.python.org/en/latest/specifications/pyproject-toml/?utm_source=chatgpt.com "pyproject.toml specification"
[2]: https://peps.python.org/pep-0517/?utm_source=chatgpt.com "PEP 517 – A build-system independent format for source ..."
[3]: https://peps.python.org/pep-0621/?utm_source=chatgpt.com "PEP 621 – Storing project metadata in pyproject.toml"
[4]: https://packaging.python.org/specifications/entry-points/?utm_source=chatgpt.com "Entry points specification"
[5]: https://setuptools.pypa.io/en/latest/userguide/pyproject_config.html?utm_source=chatgpt.com "Configuring setuptools using pyproject.toml files"
[6]: https://packaging.python.org/guides/using-testpypi/?utm_source=chatgpt.com "Using TestPyPI - Python Packaging User Guide"
[7]: https://pypi.org/help/?utm_source=chatgpt.com "Help"

---